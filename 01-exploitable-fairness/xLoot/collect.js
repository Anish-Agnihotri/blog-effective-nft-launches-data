// Imports
const fs = require("fs");
const ethers = require("ethers");
const { abi } = require("./abi");

// Constants
const zeroAddress = "0x0000000000000000000000000000000000000000";

// Setup
const rpc = new ethers.providers.JsonRpcProvider("http://localhost:8545");
const xLootAddress = "0x8bf2f876E2dCD2CAe9C3d272f325776c82DA366d";
const xLoot = new ethers.Contract(xLootAddress, abi, rpc);

// Collection
(async () => {
  // Load anish-agnihotri/dhof-loot probability
  let probability = JSON.parse(await fs.readFileSync("./probability.json"));

  // Collect all transfer events
  console.log("Collecting events...");
  const transferFilter = xLoot.filters.Transfer();
  const events = await xLoot.queryFilter(transferFilter);
  console.log("Done collecting events.");

  // Filter for mints and assign to rarity
  for (let i = 0; i < events.length; i++) {
    // Check for mint
    if (events[i].args[0] === zeroAddress) {
      // Collect minted tokenId
      const tokenId = events[i].args[2].toNumber();

      // Find tokenId in probability array
      for (let j = 0; j < probability.length; j++) {
        if (tokenId === probability[j].lootId) {
          // Assign mint block number on match
          console.log(`Assigning block number for bag #${tokenId}`);
          probability[j].mintBlockNumber = events[i].blockNumber;
          probability[j].minter = events[i].args[1];
        }
      }
    }
  }

  // Save output
  await fs.writeFileSync(
    "./mints-to-probability.json",
    JSON.stringify(probability)
  );
})();
