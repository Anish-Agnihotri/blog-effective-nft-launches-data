// Imports
const fs = require("fs");
const ethers = require("ethers");
const { abi } = require("./abi");

// Constants
const zeroAddress = "0x0000000000000000000000000000000000000000";

// Setup
const rpc = new ethers.providers.JsonRpcProvider("http://localhost:8545");
const mLootAddress = "0x1dfe7Ca09e99d10835Bf73044a23B73Fc20623DF";
const mLoot = new ethers.Contract(mLootAddress, abi, rpc);

// Collection
(async () => {
  // Load anish-agnihotri/dhof-loot probability
  let probability = JSON.parse(await fs.readFileSync("./probability.json"));

  // Collect all transfer events
  console.log("Collecting events...");
  const transferFilter = mLoot.filters.Transfer();
  const events = await mLoot.queryFilter(transferFilter);
  console.log("Done collecting events.");

  // Filter for mints and assign to rarity
  let mints = [];
  for (let i = 0; i < events.length; i++) {
    // Check for mint
    if (events[i].args[0] === zeroAddress) {
      // Collect minted tokenId
      const tokenId = events[i].args[2].toNumber();

      // Find tokenId in probability array
      for (let j = 0; j < probability.length; j++) {
        if (tokenId === probability[j].lootId) {
          // Assign mint block number on match
          console.log(`Assigning block number for bag #${tokenId}`);
          mints.push({
            ...probability,
            mintBlockNumber: events[i].blockNumber,
            minter: events[i].args[1],
          });
        }
      }
    }
  }

  // Save output
  await fs.writeFileSync(
    "./mints-to-probability.json",
    JSON.stringify(probability)
  );
})();
